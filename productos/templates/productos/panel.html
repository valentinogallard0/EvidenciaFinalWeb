{% extends "productos/panel_layout.html" %}

{% block hero_actions %}
  <a href="{% url 'panel_catalogo' %}" class="btn btn-light btn-lg fw-semibold">Ver catálogo</a>
  <a href="{% url 'panel_categorias' %}" class="btn btn-outline-light btn-lg fw-semibold">Gestionar categorías</a>
{% endblock %}

{% block content %}
  <div id="feedback" class="alert-space mb-4" role="alert"></div>
  <section class="glass-card">
    <div class="mb-3">
      <p class="eyebrow mb-1">Inventario</p>
      <h2 class="h4 mb-1" id="formTitle">Nuevo producto</h2>
      <p class="text-muted small mb-0">
        Completa el formulario para agregar artículos a la tienda o edítalos desde el catálogo.
      </p>
    </div>
    <form id="productoForm" class="row g-3" novalidate>
      <input type="hidden" id="productoId">
      <div class="col-12">
        <label class="form-label" for="nombre">Nombre</label>
        <input class="form-control" type="text" id="nombre" required placeholder="Ej. Módulo inalámbrico">
      </div>
      <div class="col-12">
        <label class="form-label" for="descripcion">Descripción</label>
        <textarea class="form-control form-textarea" id="descripcion" rows="3"
                  placeholder="Breve descripción del producto"></textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="precio">Precio</label>
        <input class="form-control" type="number" step="0.01" id="precio" required placeholder="0.00">
      </div>
      <div class="col-md-6">
        <label class="form-label" for="stock">Stock</label>
        <input class="form-control" type="number" min="0" id="stock" value="0" required>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="categoria">Categoría</label>
        <select class="form-select" id="categoria" required></select>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="imagen">URL de la imagen</label>
        <input class="form-control" type="url" id="imagen" placeholder="https://...">
      </div>
      <div class="col-12 d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1" id="submitBtn">Crear</button>
        <button type="button" class="btn btn-outline-secondary flex-grow-1 d-none" id="cancelBtn">Cancelar</button>
      </div>
    </form>
  </section>

  {{ categorias|json_script:"categorias-data" }}
{% endblock %}

{% block scripts %}
  <script>
    const feedback = document.getElementById("feedback");
    const form = document.getElementById("productoForm");
    const cancelBtn = document.getElementById("cancelBtn");
    const submitBtn = document.getElementById("submitBtn");
    const formTitle = document.getElementById("formTitle");
    const productoIdField = document.getElementById("productoId");
    const categoriasDataElement = document.getElementById("categorias-data");
    const urlParams = new URLSearchParams(window.location.search);
    const productoInicial = urlParams.get("producto");

    let categoriasCache = [];

    if (categoriasDataElement) {
      try {
        categoriasCache = JSON.parse(categoriasDataElement.textContent || "[]");
      } catch (error) {
        categoriasCache = [];
      }
    }

    const inputs = {
      nombre: document.getElementById("nombre"),
      descripcion: document.getElementById("descripcion"),
      precio: document.getElementById("precio"),
      stock: document.getElementById("stock"),
      imagen: document.getElementById("imagen"),
      categoria: document.getElementById("categoria"),
    };

    function getCSRFToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : "";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setFeedback(message, type = "success") {
      if (!message) {
        feedback.innerHTML = "";
        feedback.className = "alert-space mb-4";
        return;
      }
      const alertClass = type === "success" ? "alert-success" : "alert-danger";
      feedback.className = `alert-space mb-4 alert ${alertClass}`;
      feedback.textContent = message;
    }

    function renderCategoriasOptions(seleccion = null) {
      if (!categoriasCache.length) {
        inputs.categoria.innerHTML = '<option value="">Crea una categoría primero</option>';
        inputs.categoria.disabled = true;
        submitBtn.disabled = true;
        return;
      }
      inputs.categoria.disabled = false;
      submitBtn.disabled = false;
      inputs.categoria.innerHTML = categoriasCache
        .map((categoria) => `<option value="${categoria.id}">${escapeHtml(categoria.nombre)}</option>`)
        .join("");
      if (seleccion && categoriasCache.find((cat) => String(cat.id) === String(seleccion))) {
        inputs.categoria.value = String(seleccion);
      }
      if (!inputs.categoria.value) {
        inputs.categoria.value = String(categoriasCache[0].id);
      }
    }

    function resetForm() {
      form.reset();
      productoIdField.value = "";
      renderCategoriasOptions();
      submitBtn.textContent = "Crear";
      formTitle.textContent = "Nuevo producto";
      cancelBtn.classList.add("d-none");
      inputs.stock.value = "0";
    }

    function setFormValues(producto) {
      productoIdField.value = producto.id;
      inputs.nombre.value = producto.nombre;
      inputs.descripcion.value = producto.descripcion || "";
      inputs.precio.value = producto.precio;
      inputs.stock.value = producto.stock;
      inputs.imagen.value = producto.imagen || "";
      if (producto.categoria?.id) {
        renderCategoriasOptions(producto.categoria.id);
      }
      submitBtn.textContent = "Actualizar";
      formTitle.textContent = `Editar producto #${producto.id}`;
      cancelBtn.classList.remove("d-none");
    }

    async function cargarProductoInicial(pid) {
      try {
        const respuesta = await fetch(`/api/productos/${pid}/`);
        if (!respuesta.ok) {
          throw new Error("No se encontró el producto solicitado.");
        }
        const producto = await respuesta.json();
        setFormValues(producto);
        setFeedback("Producto cargado. Realiza tus cambios y guarda.");
      } catch (error) {
        setFeedback(error.message, "error");
      }
    }

    async function guardarProducto(evento) {
      evento.preventDefault();
      const id = productoIdField.value;
      const payload = {
        nombre: inputs.nombre.value.trim(),
        descripcion: inputs.descripcion.value,
        precio: inputs.precio.value,
        stock: inputs.stock.value,
        imagen: inputs.imagen.value.trim(),
        categoria: inputs.categoria.value,
      };
      const url = id ? `/api/productos/${id}/` : "/api/productos/";
      const metodo = id ? "PUT" : "POST";

      try {
        const respuesta = await fetch(url, {
          method: metodo,
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify(payload),
        });

        if (respuesta.status === 400) {
          const { errors, error } = await respuesta.json();
          const mensaje = error || Object.values(errors || {}).join(" ");
          setFeedback(mensaje || "Revisa los datos ingresados.", "error");
          return;
        }

        if (!respuesta.ok) {
          throw new Error("No se pudo guardar el producto.");
        }

        await respuesta.json();
        setFeedback(id ? "Producto actualizado." : "Producto creado.");
        resetForm();
      } catch (error) {
        setFeedback(error.message, "error");
      }
    }

    renderCategoriasOptions();
    resetForm();
    if (productoInicial) {
      cargarProductoInicial(productoInicial);
    }

    form.addEventListener("submit", guardarProducto);
    cancelBtn.addEventListener("click", () => {
      resetForm();
      setFeedback("");
      const url = new URL(window.location.href);
      url.searchParams.delete("producto");
      window.history.replaceState({}, "", url);
    });
  </script>
{% endblock %}
