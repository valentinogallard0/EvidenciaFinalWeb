{% extends "productos/panel_layout.html" %}

{% block hero_actions %}
  <a href="{% url 'panel_productos' %}" class="btn btn-light btn-lg fw-semibold">Nuevo producto</a>
  <a href="{% url 'panel_categorias' %}" class="btn btn-outline-light btn-lg fw-semibold">Gestionar categorías</a>
{% endblock %}

{% block content %}
  <div id="feedback" class="alert-space mb-4" role="alert"></div>

  <section class="glass-card">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
      <div>
        <p class="eyebrow mb-1">Catálogo</p>
        <h2 class="h4 mb-0">Productos registrados</h2>
      </div>
      <button type="button" class="btn btn-outline-primary btn-refresh" id="refreshProductosBtn">
        <span class="icon">⟳</span>
        <span>Actualizar lista</span>
      </button>
    </div>
    <div class="table-wrapper">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Nombre</th>
              <th scope="col">Precio</th>
              <th scope="col">Stock</th>
              <th scope="col">Categoría</th>
              <th scope="col" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaProductos" data-form-url="{% url 'panel_productos' %}">
            <tr>
              <td colspan="6" class="state-row">Cargando productos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const feedback = document.getElementById("feedback");
    const tablaProductos = document.getElementById("tablaProductos");
    const refreshProductosBtn = document.getElementById("refreshProductosBtn");
    const formUrl = tablaProductos.dataset.formUrl;

    let productosCache = [];

    function getCSRFToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : "";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setFeedback(message, type = "success") {
      if (!message) {
        feedback.innerHTML = "";
        feedback.className = "alert-space mb-4";
        return;
      }
      const alertClass = type === "success" ? "alert-success" : "alert-danger";
      feedback.className = `alert-space mb-4 alert ${alertClass}`;
      feedback.textContent = message;
    }

    function productoRow(producto) {
      const categoriaNombre = producto.categoria?.nombre || "Sin categoría";
      const stockNumber = Number(producto.stock) || 0;
      const stockClass =
        stockNumber === 0 ? "badge-stock-out" : stockNumber < 5 ? "badge-stock-low" : "badge-stock-ok";
      const stockLabel = stockNumber === 0 ? "Sin stock" : `${stockNumber} uds`;
      const editHref = `${formUrl}?producto=${producto.id}`;
      return `
        <tr data-id="${producto.id}">
          <td>
            <span class="badge rounded-pill bg-light text-dark fw-semibold">#${producto.id}</span>
          </td>
          <td>
            <div class="fw-semibold text-dark">${escapeHtml(producto.nombre)}</div>
            <div class="text-muted small">ID: ${producto.id}</div>
          </td>
          <td>
            <span class="badge price-badge">$${escapeHtml(producto.precio)}</span>
          </td>
          <td>
            <span class="badge ${stockClass}">${escapeHtml(stockLabel)}</span>
          </td>
          <td>
            <span class="group-pill">${escapeHtml(categoriaNombre)}</span>
          </td>
          <td class="text-end">
            <div class="d-flex justify-content-end gap-2 flex-wrap">
              <a class="btn btn-soft btn-soft-primary" href="${editHref}">Editar</a>
              <button class="btn btn-soft btn-soft-danger" data-action="eliminar">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    function renderProductos() {
      if (!productosCache.length) {
        tablaProductos.innerHTML = `
          <tr>
            <td colspan="6" class="state-row text-muted">Aún no hay productos registrados.</td>
          </tr>
        `;
        return;
      }

      const agrupados = new Map();
      productosCache.forEach((producto) => {
        const categoriaNombre = producto.categoria?.nombre || "Sin categoría";
        if (!agrupados.has(categoriaNombre)) {
          agrupados.set(categoriaNombre, []);
        }
        agrupados.get(categoriaNombre).push(producto);
      });

      const categoriasOrdenadas = Array.from(agrupados.keys()).sort((a, b) => a.localeCompare(b));
      let contenido = "";
      categoriasOrdenadas.forEach((nombreCategoria) => {
        contenido += `
          <tr class="table-group-row">
            <td colspan="6">
              <span class="group-pill">${escapeHtml(nombreCategoria)}</span>
            </td>
          </tr>
        `;
        agrupados.get(nombreCategoria).forEach((producto) => {
          contenido += productoRow(producto);
        });
      });

      tablaProductos.innerHTML = contenido;
    }

    async function cargarProductos() {
      tablaProductos.innerHTML = `
        <tr>
          <td colspan="6" class="state-row text-muted">Cargando productos...</td>
        </tr>
      `;
      try {
        const respuesta = await fetch("/api/productos/");
        if (!respuesta.ok) {
          throw new Error("No se pudo obtener la lista de productos.");
        }
        const datos = await respuesta.json();
        productosCache = datos.results || [];
        renderProductos();
      } catch (error) {
        tablaProductos.innerHTML = `
          <tr>
            <td colspan="6" class="state-row text-danger">${escapeHtml(error.message)}</td>
          </tr>
        `;
      }
    }

    async function eliminarProducto(id, fila) {
      if (!confirm("¿Seguro que deseas eliminar este producto?")) {
        return;
      }
      if (fila) {
        fila.classList.add("row-removing");
      }
      try {
        const respuesta = await fetch(`/api/productos/${id}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": getCSRFToken(),
          },
        });
        if (!respuesta.ok && respuesta.status !== 204) {
          throw new Error("No se pudo eliminar el producto.");
        }
        setFeedback("Producto eliminado.");
        if (fila) {
          fila.addEventListener(
            "animationend",
            () => {
              productosCache = productosCache.filter((producto) => String(producto.id) !== String(id));
              renderProductos();
            },
            { once: true },
          );
        } else {
          productosCache = productosCache.filter((producto) => String(producto.id) !== String(id));
          renderProductos();
        }
      } catch (error) {
        if (fila) {
          fila.classList.remove("row-removing");
        }
        setFeedback(error.message, "error");
      }
    }

    function manejarAccionTabla(evento) {
      const boton = evento.target.closest("button[data-action]");
      if (!boton) {
        return;
      }
      const fila = boton.closest("tr[data-id]");
      const id = fila?.dataset.id;
      if (!id) {
        return;
      }
      if (boton.dataset.action === "eliminar") {
        eliminarProducto(id, fila);
      }
    }

    tablaProductos.addEventListener("click", manejarAccionTabla);
    refreshProductosBtn.addEventListener("click", cargarProductos);

    cargarProductos();
  </script>
{% endblock %}
